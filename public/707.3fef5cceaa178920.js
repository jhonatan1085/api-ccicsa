"use strict";(self.webpackChunkpreclinic_angular=self.webpackChunkpreclinic_angular||[]).push([[707],{3583:(y,L,e)=>{e.d(L,{a:()=>_});var l=e(7700),t=e(5879),E=e(342),v=e(2939),$=e(2893),g=e(3059),f=e(1303),p=e(6223),n=e(7816),a=e(6814),o=e(9157),b=e(8525),i=e(3680),s=e(2296);function r(C,d){if(1&C&&(t.TgZ(0,"mat-option",21),t._uU(1),t.qZA()),2&C){const c=d.$implicit;t.Q6J("value",c.id),t.xp6(1),t.hij(" ",c.nombre," ")}}function h(C,d){if(1&C&&(t.TgZ(0,"mat-option",21),t._uU(1),t.qZA()),2&C){const c=d.$implicit;t.Q6J("value",c.id),t.xp6(1),t.hij(" ",c.nombre," ")}}function m(C,d){if(1&C&&(t.TgZ(0,"mat-option",21),t._uU(1),t.qZA()),2&C){const c=d.$implicit;t.Q6J("value",c.id),t.xp6(1),t.hij(" ",c.nombre," ")}}let _=(()=>{class C{constructor(c,u,T,D,U,O,P,A,M){this.dialogRef=c,this.data=u,this.clipboard=T,this._snackBar=D,this.bitacoraService=U,this.configService=O,this.router=P,this.fb=A,this.utilities=M,this.herramientas="",this.tiempo="",this.causa=[],this.consecuencia=[],this.tipoReparacion=[],this.bitacora=u.bitacora,this.datosForm=this.fb.group({causa_averia_id:[this.bitacora.causa_averia?.id??null],consecuencia_averia_id:[this.bitacora.consecuencia_averia?.id??null],tipo_reparacion_id:[this.bitacora.tipo_reparacion?.id??null],herramientas:[this.bitacora.herramientas??null],tiempo_solucion:[this.bitacora.tiempo_solucion??null]}),this.configService.bitacorasFinalizar().subscribe(B=>{this.causa=B.causa,this.consecuencia=B.consecuencia,this.tipoReparacion=B.tipoReparacion})}guardar(){if(!this.bitacora.latitud||!this.bitacora.longitud)return void this.utilities.snackBar("La bitacora no puede ser cerrada, no cuenta con latitud y longitud");const c={...this.bitacora,...this.datosForm.value};this.bitacoraService.finalizar(c).subscribe(u=>{console.log(u),403==u.message?this.snackBar("Falta ingresar datos"):(this.snackBar("Registro Exitoso"),this.dialogRef.close(),this.router.navigate(["/bitacoras/list-bitacora"]))})}snackBar(c){this._snackBar.open(c,"Cerrar",{horizontalPosition:"right",verticalPosition:"top",duration:3e3})}static#t=this.\u0275fac=function(u){return new(u||C)(t.Y36(l.so),t.Y36(l.WI),t.Y36(E.TU),t.Y36(v.ux),t.Y36($.k),t.Y36(g.E),t.Y36(f.F0),t.Y36(p.qu),t.Y36(n.e))};static#i=this.\u0275cmp=t.Xpm({type:C,selectors:[["app-end-bitacoras"]],decls:48,vars:5,consts:[["mat-dialog-title",""],[1,"mat-typography"],[1,"row"],[1,"col-sm-12"],[1,"card"],[1,"card-body"],[1,"row",3,"formGroup"],[1,"col-12","col-md-6","col-xl-4"],[1,"form-group","local-forms"],[1,"login-danger"],["formControlName","causa_averia_id","placeholder","Seleccione Causa",1,"form-control","select"],[3,"value",4,"ngFor","ngForOf"],["formControlName","consecuencia_averia_id","placeholder","Seleccione Consecuencia",1,"form-control","select"],["formControlName","tipo_reparacion_id","placeholder","Seleccione Tipo Rep.",1,"form-control","select"],["for","tiempo_solucion"],["formControlName","tiempo_solucion","name","tiempo_solucion","type","text",1,"form-control"],["for","herramientas"],["name","herramientas","rows","5","cols","10","formControlName","herramientas",1,"form-control"],["align","end"],["mat-button","","mat-dialog-close",""],["mat-button","","cdkFocusInitial","",3,"click"],[3,"value"]],template:function(u,T){1&u&&(t.TgZ(0,"h2",0),t._uU(1),t.qZA(),t.TgZ(2,"mat-dialog-content",1)(3,"div",2)(4,"div",3)(5,"div",4)(6,"div",5)(7,"form")(8,"div",6)(9,"div",7)(10,"div",8)(11,"mat-label"),t._uU(12,"Causa Averia "),t.TgZ(13,"span",9),t._uU(14,"*"),t.qZA()(),t.TgZ(15,"mat-select",10),t.YNc(16,r,2,2,"mat-option",11),t.qZA()()(),t.TgZ(17,"div",7)(18,"div",8)(19,"mat-label"),t._uU(20,"Consecuencia "),t.TgZ(21,"span",9),t._uU(22,"*"),t.qZA()(),t.TgZ(23,"mat-select",12),t.YNc(24,h,2,2,"mat-option",11),t.qZA()()(),t.TgZ(25,"div",7)(26,"div",8)(27,"mat-label"),t._uU(28,"Tipo de Reparaci\xf3n "),t.TgZ(29,"span",9),t._uU(30,"*"),t.qZA()(),t.TgZ(31,"mat-select",13),t.YNc(32,m,2,2,"mat-option",11),t.qZA()()(),t.TgZ(33,"div",7)(34,"div",8)(35,"mat-label",14),t._uU(36,"Tiempo atenci\xf3n "),t.qZA(),t._UZ(37,"input",15),t.qZA()(),t.TgZ(38,"div",7)(39,"div",8)(40,"mat-label",16),t._uU(41,"Material Utilizado "),t.qZA(),t._UZ(42,"textarea",17),t.qZA()()()()()()()()(),t.TgZ(43,"mat-dialog-actions",18)(44,"button",19),t._uU(45,"Cerrar"),t.qZA(),t.TgZ(46,"button",20),t.NdJ("click",function(){return T.guardar()}),t._uU(47,"Guardar"),t.qZA()()),2&u&&(t.xp6(1),t.hij("Finalizar Bitacora: ",T.bitacora.nombre,""),t.xp6(7),t.Q6J("formGroup",T.datosForm),t.xp6(8),t.Q6J("ngForOf",T.causa),t.xp6(8),t.Q6J("ngForOf",T.consecuencia),t.xp6(8),t.Q6J("ngForOf",T.tipoReparacion))},dependencies:[a.sg,o.hX,b.gD,i.ey,s.lW,l.ZT,l.uh,l.xY,l.H8,p._Y,p.Fj,p.JJ,p.JL,p.F,p.sg,p.u]})}return C})()},9909:(y,L,e)=>{e.d(L,{D:()=>m});var l=e(7700),t=e(5879),E=e(342),v=e(2939),$=e(2893),g=e(3059),f=e(9368),p=e(2122),n=e(9862),a=e(3586);let o=(()=>{class _ extends f.p{constructor(d,c){super(d,c,"sites"),this.http=d,this.authService=c}showProvinciasDep(d){const c=this.getHeaders();return this.http.get(`${p.$g}/provinciasdep/${d}`,{headers:c})}showDistritoProv(d){const c=this.getHeaders();return this.http.get(`${p.$g}/distritoprov/${d}`,{headers:c})}createLocationBitacora(d){const c=this.getHeaders();return this.http.post(`${p.$g}/bitacoras/localizacion`,d,{headers:c})}static#t=this.\u0275fac=function(c){return new(c||_)(t.LFG(n.eN),t.LFG(a.e))};static#i=this.\u0275prov=t.Yz7({token:_,factory:_.\u0275fac,providedIn:"root"})}return _})();var b=e(1303),i=e(6223),s=e(7816),r=e(9157),h=e(2296);let m=(()=>{class _{constructor(d,c,u,T,D,U,O,P,A,M){this.dialogRef=d,this.data=c,this.clipboard=u,this._snackBar=T,this.bitacoraService=D,this.configService=U,this.locationService=O,this.router=P,this.fb=A,this.utilities=M,this.bitacora=c.bitacora,this.datosForm=this.fb.group({latitud:[this.bitacora.latitud],longitud:[this.bitacora.longitud],distancia:[this.bitacora.distancia]},{validators:[this.utilities.validateCoordinates.bind(this.utilities)]})}guardar(){const d={...this.bitacora,...this.datosForm.value};console.log(d),this.locationService.createLocationBitacora(d).subscribe(c=>{403==c.message?this.utilities.snackBar("Falta ingresar datos"):(this.utilities.snackBar("Registro Exitoso"),this.dialogRef.close(),this.router.navigate(["/bitacoras/list-bitacora"]))})}getLocation(){this.bitacoraService.getPosition().then(d=>{this.bitacora.latitud=d.lat,this.bitacora.longitud=d.lng,this.datosForm.patchValue({latitud:this.bitacora.latitud,longitud:this.bitacora.longitud})})}static#t=this.\u0275fac=function(c){return new(c||_)(t.Y36(l.so),t.Y36(l.WI),t.Y36(E.TU),t.Y36(v.ux),t.Y36($.k),t.Y36(g.E),t.Y36(o),t.Y36(b.F0),t.Y36(i.qu),t.Y36(s.e))};static#i=this.\u0275cmp=t.Xpm({type:_,selectors:[["app-location-bitacoras"]],decls:34,vars:5,consts:[["mat-dialog-title",""],[1,"mat-typography"],[1,"row"],[1,"col-sm-12"],[1,"card"],[1,"card-body"],[1,"row",3,"formGroup"],[1,"col-12","col-md-6","col-xl-3"],[1,"form-group","local-forms"],["for","latitud"],["formControlName","latitud","name","latitud","type","text",1,"form-control"],["for","longitud"],["formControlName","longitud","name","longitud","type","text",1,"form-control"],[1,"col-12","col-md-6","col-xl-2"],["for","distancia"],["formControlName","distancia","name","distancia","type","number",1,"form-control"],[1,"btn","btn-primary","ms-1"],["aria-hidden","true",1,"fas","fa-map-marker-alt",3,"click"],["target","_blank",1,"btn","btn-primary","ms-1",3,"href"],["aria-hidden","true",1,"fa","fa-map",3,"click"],["align","end"],["mat-button","","mat-dialog-close",""],["mat-button","","cdkFocusInitial","",3,"disabled","click"]],template:function(c,u){1&c&&(t.TgZ(0,"h2",0),t._uU(1),t.qZA(),t.TgZ(2,"mat-dialog-content",1)(3,"div",2)(4,"div",3)(5,"div",4)(6,"div",5)(7,"form")(8,"div",6)(9,"div",7)(10,"div",8)(11,"mat-label",9),t._uU(12," Latitud "),t.qZA(),t._UZ(13,"input",10),t.qZA()(),t.TgZ(14,"div",7)(15,"div",8)(16,"mat-label",11),t._uU(17," Longitud "),t.qZA(),t._UZ(18,"input",12),t.qZA()(),t.TgZ(19,"div",13)(20,"div",8)(21,"mat-label",14),t._uU(22,"Distancia "),t.qZA(),t._UZ(23,"input",15),t.qZA()(),t.TgZ(24,"div",7)(25,"button",16)(26,"i",17),t.NdJ("click",function(){return u.getLocation()}),t.qZA()(),t.TgZ(27,"a",18)(28,"i",19),t.NdJ("click",function(){return u.getLocation()}),t.qZA()()()()()()()()()(),t.TgZ(29,"mat-dialog-actions",20)(30,"button",21),t._uU(31,"Cerrar"),t.qZA(),t.TgZ(32,"button",22),t.NdJ("click",function(){return u.guardar()}),t._uU(33,"Guardar"),t.qZA()()),2&c&&(t.xp6(1),t.hij("Ubicaci\xf3n de: ",u.bitacora.nombre,""),t.xp6(7),t.Q6J("formGroup",u.datosForm),t.xp6(19),t.hYB("href","https://www.google.com/maps/search/?api=1&query=",u.bitacora.latitud,",",u.bitacora.longitud,"",t.LSH),t.xp6(5),t.Q6J("disabled",u.datosForm.invalid))},dependencies:[r.hX,h.lW,l.ZT,l.uh,l.xY,l.H8,i._Y,i.Fj,i.wV,i.JJ,i.JL,i.F,i.sg,i.u]})}return _})()},2893:(y,L,e)=>{e.d(L,{k:()=>g});var l=e(2122),t=e(9368),E=e(5879),v=e(9862),$=e(3586);let g=(()=>{class f extends t.p{constructor(n,a){super(n,a,"bitacoras"),this.http=n,this.authService=a,this.apiUrlEnviaWhasap="http://localhost:3000/api/enviar-whatsapp",this.apiUrlNode="http://localhost:3000/api/qr"}createAtencionBitacora(n){const a=this.getHeaders();return this.http.post(`${l.$g}/${this.endpoint}/atenciones`,n,{headers:a})}finalizar(n){const a=this.getHeaders();return this.http.post(`${l.$g}/${this.endpoint}/finalizar`,n,{headers:a})}demoras(n){const a=this.getHeaders();return this.http.post(`${l.$g}/${this.endpoint}/demoras`,n,{headers:a})}listAtencion(n){const a=this.getHeaders();return this.http.get(`${l.$g}/${this.endpoint}/atencion/${n}`,{headers:a})}listDemoras(n){const a=this.getHeaders();return this.http.get(`${l.$g}/${this.endpoint}/demoras/${n}`,{headers:a})}getPosition(){return new Promise((n,a)=>{navigator.geolocation.getCurrentPosition(o=>{n({lng:o.coords.longitude,lat:o.coords.latitude})},o=>{a(o)})})}exportExcel(){const n=this.getHeaders();return this.http.get(`${l.$g}/${this.endpoint}/exportaBitacoras`,{headers:n})}closedSot(n){const a=this.getHeaders();return this.http.patch(`${l.$g}/${this.endpoint}/closed-sot/${n}`,{},{headers:a})}groupWhastApp(n){const a=this.getHeaders();return this.http.get(`${l.$g}/${this.endpoint}/group-whastApp/${n}`,{headers:a})}static#t=this.\u0275fac=function(a){return new(a||f)(E.LFG(v.eN),E.LFG($.e))};static#i=this.\u0275prov=E.Yz7({token:f,factory:f.\u0275fac,providedIn:"root"})}return f})()},7816:(y,L,e)=>{e.d(L,{e:()=>a});var l=e(5619),t=e(6321),E=e(4825),$=e(5879),g=e(6814),f=e(2939),p=e(2893),n=e(5159);let a=(()=>{class o{constructor(i,s,r,h){this.datePipe=i,this._snackBar=s,this.bitacoraService=r,this.whatsapp=h,this.sessionId="",this.pollingSub=null,this.qrSubject=new l.X(""),this.qrImagen$=this.qrSubject.asObservable(),this.estadoSubject=new l.X("esperando_qr"),this.estado$=this.estadoSubject.asObservable(),this.PERU_BOUNDS={minLat:-18,maxLat:-.1,minLong:-81.4,maxLong:-68.5},this.iniciarSesion()}armaBitacora(i){let h,s=this.brigadas(i.brigadas),r=this.atenciones(i.atenciones),m="";return"0"===i.estado&&(m=`\n*Causa:* ${i.causa_averia.nombre}; \n*Consecuencia:* ${i.consecuencia_averia.nombre}; \n*Tipo de Reparaci\xf3n:* ${i.tipo_reparacion.nombre}; \n*Tiempo de soluci\xf3n:* ${i.tiempo_solucion||""}; \n*Material Utilizado:* \n${i.herramientas||"- Sin materiales"}\n`),h=`#*${i.nombre} - ${i.enlace_plano_site}* \n_FechaInicial:_ ${i.fecha_inicial||""} \n_NroSot:_ ${i.sot||""} \n_NroIncidencia:_ ${i.incidencia||""} \n_NroTAS:_ ${i.nro_tas||""} \n_NroCRQ:_ ${i.nro_crq||""} \n_TipoAveria:_ ${i.tipo_averia.nombre||""} \n_TipoSitePop:_ ${i.site.tipo_site?.nombre||""} \n_NombreSite:_ *${i.site.nombre||""}* \n_NombreCliente:_ *${i.cliente||""}* \n_Lat:_ ${i.latitud||""}, _Lon:_ ${i.longitud||""} \n_Distancia:_ ${i.distancia||""} Kms \n_Region:_ ${i.site.region||""} \n_Departamento:_ ${i.site.departamento?.nombre||""} \n_Distrito:_ ${i.site.distrito?.nombre||""} \n_red1:_ ${i.red.nombre||""} , ${s}\n_Responsable Cicsa:_ ${i.resp_cicsa.nombres||""} -T: ${i.resp_cicsa.telefono||""} \n_Responsable Claro:_ ${i.resp_claro.nombres||""} -T: ${i.resp_claro.telefono||""} \n${m}\n${r} `,h}atenciones(i){var s="";return i.forEach(r=>{r.bitacora_atencion.forEach(m=>{const _=this.datePipe.transform(m.hora,"HH:mm");s+="0"==m.is_coment?` *${_}* ${m.descripcion} \n`:`   *-* ${m.descripcion} \n`});const h=this.datePipe.transform(r.hora,"HH:mm");s+=` *${h} (${r.atencion.orden}) ${r.atencion.descripcion}*, ${r.descripcion} \n`}),s}brigadas(i){let s="",r=1;return i.forEach(h=>{h.user_movil.forEach(m=>{"1"===m.is_lider&&(s+=`\n_Bri${r}:_ ${h.zona.nombre}: ${m.user.nombre} - Placa: ${m.unidad_movil?.placa||""} Cel: ${m.user.celular||""}`,r++)})}),s}obtenerCuadrante(i){const[s,r]=i.split(":").map(Number),h=60*s+r;return h>=420&&h<=779?"Ma\xf1ana":h>=780&&h<=1139?"Tarde":h>=1140&&h<=1439?"Noche":"Madrugada"}TotalDemoras(i){let s=0;for(let m=0;m<i.length;m++){const _=i[m];s+=new Date(_.fecha_fin).valueOf()-new Date(_.fecha_inicio).valueOf()}const r=Math.floor(s/1e3/60/60),h=s/1e3/60-60*r;return r.toString().padStart(2,"0")+":"+h.toString().padStart(2,"0")}isValidCoordinate(i){return!isNaN(i)&&null!==i}validateLatLong(i,s){return i>=-18&&i<=-.1&&s>=-81&&s<=-68}validateCoordinates(i){const s=i.get("latitud")?.value,r=i.get("longitud")?.value;return null!==s&&""!==s||null!==r&&""!==r?s&&(null===r||""===r)||r&&(null===s||""===s)?{missingCoordinate:!0}:s&&!this.isValidCoordinate(s)?{invalidLatitude:!0}:r&&!this.isValidCoordinate(r)?{invalidLongitude:!0}:s&&r&&!this.validateLatLong(s,r)?{outOfPeru:!0}:null:null}snackBar(i){this._snackBar.open(i,"Cerrar",{horizontalPosition:"right",verticalPosition:"top",duration:3e3})}isMobile(){const i=navigator.userAgent.toLowerCase();return["android","iphone","ipad","ipod","blackberry","windows phone","opera mini","mobile"].some(r=>i.includes(r))}iniciarSesion(){const i=localStorage.getItem("user"),s=i?JSON.parse(i):null;s&&s.name&&(this.sessionId=s.whatsapp),this.whatsapp.iniciarSesion(this.sessionId).subscribe({next:r=>{console.log("QR recibido:",r.qr),this.qrSubject.next(r.qr),this.verificarEstado()},error:()=>{this.estadoSubject.next("error"),this.qrSubject.next("")}})}verificarEstado(){this.pollingSub&&this.pollingSub.unsubscribe(),this.pollingSub=function v(o=0,b=t.z){return o<0&&(o=0),(0,E.H)(o,o,b)}(3e3).subscribe(()=>{this.whatsapp.obtenerEstado(this.sessionId).subscribe({next:i=>{i.ready?(this.estadoSubject.next("conectado"),this.qrSubject.next(""),this.pollingSub?.unsubscribe()):this.estadoSubject.next("esperando_qr")},error:()=>{this.estadoSubject.next("error"),this.qrSubject.next("")}})})}enviarMensajeAGrupos(i,s,r){var h="";this.bitacoraService.read(r).subscribe(m=>{h=this.armaBitacora(m),this.whatsapp.enviarMensajeAGrupos(i,s,h).subscribe({next:_=>this.snackBar("Mensaje enviado al grupo"),error:_=>this.snackBar("Error al enviar")})})}static#t=this.\u0275fac=function(s){return new(s||o)($.LFG(g.uU),$.LFG(f.ux),$.LFG(p.k),$.LFG(n.C))};static#i=this.\u0275prov=$.Yz7({token:o,factory:o.\u0275fac,providedIn:"root"})}return o})()},5159:(y,L,e)=>{e.d(L,{C:()=>E});var l=e(5879),t=e(9862);let E=(()=>{class v{constructor(g){this.http=g,this.apiUrl="http://localhost:3000"}iniciarSesion(g){return this.http.post(`${this.apiUrl}/session`,{sessionId:g})}obtenerEstado(g){return this.http.get(`${this.apiUrl}/session/${g}/status`)}enviarMensajeAGrupos(g,f,p){return this.http.post(`${this.apiUrl}/send`,{sessionId:g,groupNames:f,message:p})}static#t=this.\u0275fac=function(f){return new(f||v)(l.LFG(t.eN))};static#i=this.\u0275prov=l.Yz7({token:v,factory:v.\u0275fac,providedIn:"root"})}return v})()},342:(y,L,e)=>{e.d(L,{TU:()=>v});var l=e(6814),t=e(5879);class E{constructor(n,a){this._document=a;const o=this._textarea=this._document.createElement("textarea"),b=o.style;b.position="fixed",b.top=b.opacity="0",b.left="-999em",o.setAttribute("aria-hidden","true"),o.value=n,o.readOnly=!0,(this._document.fullscreenElement||this._document.body).appendChild(o)}copy(){const n=this._textarea;let a=!1;try{if(n){const o=this._document.activeElement;n.select(),n.setSelectionRange(0,n.value.length),a=this._document.execCommand("copy"),o&&o.focus()}}catch{}return a}destroy(){const n=this._textarea;n&&(n.remove(),this._textarea=void 0)}}let v=(()=>{class p{constructor(a){this._document=a}copy(a){const o=this.beginCopy(a),b=o.copy();return o.destroy(),b}beginCopy(a){return new E(a,this._document)}static#t=this.\u0275fac=function(o){return new(o||p)(t.LFG(l.K0))};static#i=this.\u0275prov=t.Yz7({token:p,factory:p.\u0275fac,providedIn:"root"})}return p})()}}]);